

- name: /etc/passwd
  file:
    path: /etc/passwd
    owner: root  # TWGCB-01-012-0045, TWGCB-01-008-0045, TWGCB-01-003-0041
    group: root  # TWGCB-01-012-0045, TWGCB-01-008-0045, TWGCB-01-003-0042
    mode: '0644' # TWGCB-01-012-0046, TWGCB-01-008-0046, TWGCB-01-003-0040

- name: /etc/shadow
  file:
    path: /etc/shadow
    owner: root  # TWGCB-01-012-0047, TWGCB-01-008-0047, TWGCB-01-003-0035
    group: root  # TWGCB-01-012-0047, TWGCB-01-008-0047, TWGCB-01-003-0036
    mode: '0000' # TWGCB-01-012-0048, TWGCB-01-008-0048, TWGCB-01-003-0034

- name: /etc/group
  file:
    path: /etc/group
    owner: root  # TWGCB-01-012-0049, TWGCB-01-008-0049, TWGCB-01-003-0038
    group: root  # TWGCB-01-012-0049, TWGCB-01-008-0049, TWGCB-01-003-0039
    mode: '0644' # TWGCB-01-012-0050, TWGCB-01-008-0050, TWGCB-01-003-0037

- name: /etc/gshadow
  file:
    path: /etc/gshadow
    owner: root  # TWGCB-01-012-0051, TWGCB-01-008-0051, TWGCB-01-003-0032
    group: root  # TWGCB-01-012-0051, TWGCB-01-008-0051, TWGCB-01-003-0033
    mode: '0000' # TWGCB-01-012-0052, TWGCB-01-008-0052, TWGCB-01-003-0031


#################### execute in RedHat 6 ####################

# - name: execute in RedHat 6
#   when: ansible_os_family == "RedHat" and ansible_distribution_major_version in ["6"]
#   block:

#################### execute in RedHat 7 ####################

- name: execute in RedHat 7
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version in ["7"]
  block:
  - name: /etc/sysctl.conf RedHat7
    template:
      owner: root
      group: root
      mode: 0644
      dest: /etc/sysctl.conf
      src: "{{ etc_sysctl_redhat7_conf }}"

#################### execute in RedHat 5 6 ####################

- name: execute in RedHat 5 6
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version in ["5","6"]
  block:
  - name: /etc/sysctl.conf RedHat6
    template:
      owner: root
      group: root
      mode: 0644
      dest: /etc/sysctl.conf
      src: "{{ etc_sysctl_redhat6_conf }}"

#################### execute in RedHat 5 6 7 ####################

- name: execute in RedHat 5 6 7
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version in ["5","6","7"]
  block:
  - name: /etc/security/limits.conf TWGCB_003
    template:
      owner: root
      group: root
      mode: 0644
      dest: /etc/security/limits.d/gcb.conf
      src: "{{ TWGCB_003_limits_gcb_conf }}"

  - name: /etc/security/console.perms
    template:
      owner: root
      group: root
      mode: 0644
      dest: /etc/security/console.perms
      src: "{{ console_perms }}"

#################### execute in RedHat older 8 ####################

- name: execute in RedHat older 8
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version | int >= 8
  block:
  - name: Gather the package facts
    ansible.builtin.package_facts:
      manager: auto

  - name: 已安裝coredump服務 才需要處理
    when: "'coredump' in ansible_facts.packages"
    block:
    - name: /etc/systemd/coredump.conf
      template:
        owner: root
        group: root
        mode: 0644
        dest: /etc/systemd/coredump.conf
        src: "{{ coredump_conf }}"

    - name: execute command
      command: "{{ item }}"
      with_items: 
      - systemctl daemon-reload # TWGCB-01-008-0042
      - systemctl mask systemd-coredump.socket # TWGCB-01-008-0042
      - rmmod cramfs # TWGCB-01-008-0001
      - rmmod squashfs # TWGCB-01-008-0002
      - rmmod udf # TWGCB-01-008-0003
      - rmmod usb-storage # TWGCB-01-008-0031
      - sysctl -w fs.suid_dumpable=0 # TWGCB-01-008-0042
      - sysctl -w kernel.core_pattern=|/bin/false # TWGCB-01-008-0042
      - sysctl -w kernel.randomize_va_space=2 # TWGCB-01-008-0042


  # 設定全域寫入權限目錄之粘滯位: TWGCB-01-008-0029, TWGCB-01-012-0029

  - name: 設定全域寫入權限目錄之粘滯位
    ignore_errors: true
    shell: df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -type d \( -perm -0002 -a ! -perm -1000 \) 2>/dev/null | xargs -I '{}' chmod o+t '{}'
    args:
      executable: /bin/bash
      
  - name: /etc/passwd-
    file:
      path: /etc/passwd-
      owner: root  # TWGCB-01-008-0053, TWGCB-01-012-0053
      group: root  # TWGCB-01-008-0053, TWGCB-01-012-0053
      mode: '0000' # TWGCB-01-008-0054, TWGCB-01-012-0054

  - name: /etc/shadow-
    file:
      path: /etc/shadow-
      owner: root  # TWGCB-01-008-0055, TWGCB-01-012-0055
      group: root  # TWGCB-01-008-0055, TWGCB-01-012-0055
      mode: '0000' # TWGCB-01-008-0056, TWGCB-01-012-0056

  - name: /etc/group-
    file:
      path: /etc/group-
      owner: root  # TWGCB-01-008-0057, TWGCB-01-012-0057
      group: root  # TWGCB-01-008-0057, TWGCB-01-012-0057
      mode: '0644' # TWGCB-01-008-0058, TWGCB-01-012-0058

  - name: /etc/gshadow-
    file:
      path: /etc/gshadow-
      owner: root  # TWGCB-01-008-0059, TWGCB-01-012-0059
      group: root  # TWGCB-01-008-0059, TWGCB-01-012-0059
      mode: '0000' # TWGCB-01-008-0060, TWGCB-01-012-0060